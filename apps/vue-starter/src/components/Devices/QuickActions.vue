<script setup lang="ts">
import {
  IxRow,
  IxIconButton,
  IxTooltip,
  IxDropdown,
  IxDropdownQuickActions,
  IxDropdownItem,
  IxDivider,
  showToast,
} from "@siemens/ix-vue";
import {
  iconPen,
  iconTrashcan,
  iconContextMenu,
  iconDuplicate,
  iconCut,
  iconCopy,
  iconPaste,
  iconRename,
  iconPcTower,
  iconSingleCheck,
} from "@siemens/ix-icons/icons";
import { useDeviceStore } from "@/store/deviceStore";

import { showDeleteMessage } from "@/helpers/modal";
import { useI18n } from "vue-i18n";
import { computed } from "vue";

const { t } = useI18n();

const handleDelete = async () => {
  const result = await showDeleteMessage(t);

  if (result.actionId === "okay") {
    deviceStore.deleteDevice(props.params.node.data);
    showToast({
      message: t('dropdown-quick-actions.success-messages.delete'),
      type: "success",
      icon: iconSingleCheck,
      iconColor: "color-success",
    });
  }
};

const deviceStore = useDeviceStore();

const props = defineProps(["params", "api", "node"]);

const startEditingFirstCell = () => {
  console.log(props.params.node.data);
  props.params.api.startEditingCell({
    rowIndex: props.params.node?.rowIndex,
    colKey: "deviceName",
  });
};

const toggleStatusLabel = computed(() => {
  return props.params.node.data.status === "Online" ? t('dropdown-quick-actions.off') : t('dropdown-quick-actions.on');
});

const toggleStatus = () => {
  const updatedDevice = {
    ...props.params.node.data,
    status: props.params.node.data.status === "Online" ? "Offline" : "Online",
  };

  deviceStore.editDevice(updatedDevice);

  props.params.node.setData(updatedDevice);

  props.params.api.refreshCells({
    force: true,
    rowNodes: [props.params.node],
    columns: ['status']
  });
};

const startMaintenance = () => {
  const updatedDevice = {
    ...props.params.node.data,
    status: props.params.node.data.status === "Maintenance" ? "Online" : "Maintenance",
  };
  deviceStore.editDevice(updatedDevice);
};

const duplicateRow = () => {
  const currentIndex = deviceStore.devices.findIndex((d) => d.id === props.params.node.data.id);

  const newDevice = {
    ...props.params.node.data,
    id: (deviceStore.devices.length + 1).toString(),
  };

  deviceStore.insertDevice(currentIndex + 1, newDevice);

  showToast({
    message: t('dropdown-quick-actions.success-messages.duplicate'),
    type: "success",
    icon: iconSingleCheck,
    iconColor: "color-success",
  });
};

const copyRow = () => {
  navigator.clipboard.writeText(JSON.stringify(props.params.node.data));
  showToast({
    message: t('dropdown-quick-actions.success-messages.copy'),
    type: "success",
    icon: iconSingleCheck,
    iconColor: "color-success",
  });
};

const pasteRow = async () => {
  try {
    const text = await navigator.clipboard.readText();
    const data = JSON.parse(text);
    const currentIndex = deviceStore.devices.findIndex((d) => d.id === props.params.node.data.id);

    deviceStore.insertDevice(currentIndex + 1, {
      ...data,
      id: (deviceStore.devices.length + 1).toString(),
    });
    showToast({
      message: t('dropdown-quick-actions.success-messages.paste'),
      type: "success",
      icon: iconSingleCheck,
      iconColor: "color-success",
    });
  } catch (error) {
    console.error("Error pasting device:", error);
  }
};

const copyAndDeleteRow = () => {
  copyRow();
  handleDelete();
  showToast({
    message: t('dropdown-quick-actions.success-messages.cut'),
    type: "success",
    icon: iconSingleCheck,
    iconColor: "color-success",
  });
};
</script>

<template>
  <IxRow class="quick-actions-row">
    <!-- Edit Button -->
    <IxIconButton class="edit-tooltip" aria-describedby="tooltip-edit" :icon="iconPen" variant="secondary" ghost
      @click="startEditingFirstCell" />
    <IxTooltip id="tooltip-edit" for=".edit-tooltip">{{ t('dropdown-quick-actions.rename') }}</IxTooltip>

    <!-- Delete Button -->
    <IxIconButton class="delete-tooltip" aria-describedby="tooltip-delete" :icon="iconTrashcan" variant="secondary"
      ghost @click="handleDelete" />
    <IxTooltip id="tooltip-delete" for=".delete-tooltip">{{ t('dropdown-quick-actions.delete') }}</IxTooltip>

    <!-- Context Menu -->
    <IxIconButton :icon="iconContextMenu" variant="secondary" ghost :id="`devices-${props.params.node?.rowIndex}`">
    </IxIconButton>
    <IxDropdown :trigger="`devices-${props.params.node?.rowIndex}`">
      <IxDropdownQuickActions>
        <IxIconButton :icon="iconDuplicate" ghost @click="duplicateRow"></IxIconButton>
        <IxIconButton :icon="iconCut" ghost @click="copyAndDeleteRow"></IxIconButton>
        <IxIconButton :icon="iconCopy" ghost @click="copyRow"></IxIconButton>
        <IxIconButton :icon="iconPaste" ghost @click="pasteRow"></IxIconButton>
      </IxDropdownQuickActions>
      <IxDivider></IxDivider>
      <IxDropdownItem :icon="iconRename" :label="t('dropdown-quick-actions.rename')" @click="startEditingFirstCell">
      </IxDropdownItem>
      <IxDropdownItem :icon="iconPcTower" :label="toggleStatusLabel" @click="toggleStatus"></IxDropdownItem>
      <IxDivider />
      <IxDropdownItem :icon="iconTrashcan" :label="t('dropdown-quick-actions.delete')" @click="handleDelete">
      </IxDropdownItem>
    </IxDropdown>
  </IxRow>
</template>

<style scoped>
.quick-actions-row {
  display: flex;
  gap: 0.5rem;
}
</style>