<script setup lang="ts">
import { ref, computed, onUnmounted } from "vue";
import { themeSwitcher } from "@siemens/ix";
import { IxCard, IxCardContent, IxTypography } from "@siemens/ix-vue";
import { registerTheme, getComputedCSSProperty } from "@siemens/ix-echarts";
import VueECharts from "vue-echarts";
import * as echarts from "echarts/core";
import {
  TooltipComponent,
  LegendComponent,
  GridComponent,
  MarkLineComponent,
} from "echarts/components";
import { LineChart } from "echarts/charts";
import { CanvasRenderer } from "echarts/renderers";
import { type EChartsOption } from "echarts";
import { useI18n } from "vue-i18n";
import { useChart } from "../../composables/useChart";
import { CHART_CONSTANTS, getStatusHistoryData } from "../../composables/chartConfig";

registerTheme(echarts);

echarts.use([
  TooltipComponent,
  LegendComponent,
  GridComponent,
  MarkLineComponent,
  LineChart,
  CanvasRenderer,
]);

const { t } = useI18n();
const chartRef = ref();
const theme = ref(themeSwitcher.getCurrentTheme());

const chartData = getStatusHistoryData();

const chartOption = computed((): EChartsOption => {
  theme.value;
  
  const series = Object.values(chartData.series).map(seriesData => ({
    type: "line" as const,
    name: seriesData.name,
    color: getComputedCSSProperty(seriesData.colorKey),
    data: seriesData.data,
  }));

  return {
    grid: CHART_CONSTANTS.GRID.STATUS_HISTORY,
    legend: {
      orient: "horizontal" as const,
      icon: "rect" as const,
      left: "1",
      bottom: 0,
    },
    xAxis: {
      data: chartData.months,
      boundaryGap: false,
      splitLine: { show: true },
    },
    yAxis: {
      splitLine: { show: true },
    },
    series,
  };
});

const initializeChart = async () => {};

useChart({
  chartRef,
  initializeChart,
  optionRef: chartOption
});

const themeChangeHandler = (newTheme: string) => {
  theme.value = newTheme;
};

themeSwitcher.themeChanged.on(themeChangeHandler);

onUnmounted(() => {
  themeSwitcher.themeChanged.off(themeChangeHandler);
});
</script>

<template>
  <IxCard class="status-history">
    <IxCardContent>
      <IxTypography format="label" bold>{{ t('status-history.title') }}</IxTypography>
      <VueECharts
        ref="chartRef"
        class="charts"
        :theme="theme"
        :option="chartOption"
        autoresize
        :init-options="{ renderer: CHART_CONSTANTS.RENDERER }"
      />
    </IxCardContent>
  </IxCard>
</template>

<style scoped>
.status-history {
  height: v-bind('CHART_CONSTANTS.DIMENSIONS.height');
  min-height: v-bind('CHART_CONSTANTS.DIMENSIONS.minHeight');
  max-height: v-bind('CHART_CONSTANTS.DIMENSIONS.maxHeight');
}

.charts {
  position: relative;
  width: 100%;
  height: 100%;
  padding-top: 1rem;
}
</style>
